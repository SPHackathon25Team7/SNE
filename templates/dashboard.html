<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Notification Engine Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .notification-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0 5px 5px 0;
        }
        
        .priority-high {
            border-left-color: #e74c3c;
        }
        
        .priority-medium {
            border-left-color: #f39c12;
        }
        
        .priority-low {
            border-left-color: #27ae60;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }
        
        .quick-actions {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .quick-actions h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .actions-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .value-seekers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .value-seekers-metric {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #f39c12;
        }
        
        .value-seekers-metric .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 0.5rem;
        }
        
        .value-seekers-metric .metric-label {
            color: #856404;
            font-weight: 500;
        }
        
        .insights-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .insight-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
        }
        
        .insight-card h4 {
            color: #f39c12;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-label {
            color: #495057;
            font-weight: 500;
        }
        
        .insight-value {
            color: #f39c12;
            font-weight: bold;
            background: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        
        .key-insights {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .key-insights h4 {
            color: #28a745;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .insight-point {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
        }
        
        .insight-point:last-child {
            margin-bottom: 0;
        }
        
        .insight-icon {
            color: #28a745;
            margin-right: 0.75rem;
            margin-top: 0.1rem;
            font-weight: bold;
        }
        
        .insight-text {
            color: #155724;
            line-height: 1.4;
        }
        
        /* Tab System Styles */
        .tab-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #f1f3f4;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            overflow-x: auto;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab-button.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .tab-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .tab-section h4 {
            color: #667eea;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Smart Notification Engine</h1>
        <p>Energy Supplier Customer Notification Dashboard</p>
    </div>
    
    <div class="container">
        <!-- Quick Actions at the top -->
        <div class="quick-actions">
            <h3>Smart Notification Engine</h3>
            <div class="actions-row">
                <button class="btn btn-success" onclick="loadCustomerData()">🔄 Refresh Data</button>
                <button class="btn" onclick="switchTab('notifications')">📧 View Notifications</button>
                <button class="btn" onclick="switchTab('value-seekers')">🎯 Value Seekers</button>
            </div>
        </div>
        
        <!-- Tabbed Interface -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('notifications')">📧 Smart Notifications</button>
                <button class="tab-button" onclick="switchTab('value-seekers')">🎯 Value Seekers</button>
                <button class="tab-button" onclick="switchTab('overview')">📊 Customer Data</button>
            </div>
            
            <!-- Smart Notifications Tab (Now Default) -->
            <div id="notifications-tab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="color: #28a745; margin: 0;">📧 Smart Notifications & Prioritization</h3>
                    <button class="btn" onclick="generateNotifications()" style="background: #28a745;">🤖 Analyze & Generate Notifications</button>
                </div>
                
                <!-- Notification Stats -->
                <div class="stats-grid" style="margin-bottom: 2rem;" id="notificationStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalNotifications">0</div>
                        <div class="stat-label">Total Notifications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="highPriorityCount">0</div>
                        <div class="stat-label">🔴 Critical</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="mediumPriorityCount">0</div>
                        <div class="stat-label">🟡 Important</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowPriorityCount">0</div>
                        <div class="stat-label">🟢 Routine</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgRiskScore">0</div>
                        <div class="stat-label">Avg Risk Score</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem; padding: 1rem; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 0.5rem;">🧠 AI-Powered Customer Engagement</h4>
                    <p style="margin: 0; color: #155724; font-size: 0.9rem;">
                        AI analyzes all customers, identifies who needs contact, prioritizes by urgency & risk, then generates personalized notifications. 
                        <strong>Most critical engagements appear first.</strong>
                    </p>
                </div>
                
                <!-- Priority Filter Buttons -->
                <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn" onclick="filterNotifications('all')" id="filter-all" style="background: #6c757d; font-size: 0.8rem;">All Notifications</button>
                    <button class="btn" onclick="filterNotifications('high')" id="filter-high" style="background: #dc3545; font-size: 0.8rem;">🔴 Critical Only</button>
                    <button class="btn" onclick="filterNotifications('medium')" id="filter-medium" style="background: #ffc107; color: #000; font-size: 0.8rem;">🟡 Important Only</button>
                    <button class="btn" onclick="filterNotifications('low')" id="filter-low" style="background: #28a745; font-size: 0.8rem;">🟢 Routine Only</button>
                </div>
                
                <div id="notificationData" class="loading">Click "Analyze & Generate Notifications" to see AI-prioritized customer engagements</div>
            </div>
            
            <!-- Overview Tab (Simplified) -->
            <div id="overview-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin: 0;">📊 Customer Data Overview</h3>
                </div>
                
                <!-- Key Stats -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCustomers">-</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="billingIssues">-</div>
                        <div class="stat-label">Billing Issues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="valueSeekers">-</div>
                        <div class="stat-label">Value Seekers</div>
                    </div>
                </div>
                
                <div class="tab-grid">
                    <div class="tab-section">
                        <h4>Customer Segments</h4>
                        <div id="segmentData" class="loading">Loading segments...</div>
                    </div>
                    
                    <div class="tab-section">
                        <h4>Billing Issues</h4>
                        <div id="billingData" class="loading">Loading billing issues...</div>
                    </div>
                </div>
            </div>
            

            
            <!-- Value Seekers Tab -->
            <div id="value-seekers-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="color: #f39c12; margin: 0;">🎯 Value Seekers Focus (Target Segment)</h3>
                    <button class="btn" onclick="generateValueSeekerNotifications()" style="background: #f39c12;">🎯 Generate Value Seeker Campaigns</button>
                </div>
                <div id="valueSeekerData" class="loading">Loading Value Seekers analysis...</div>
            </div>
        </div>
    </div>

    <script>
        // Chart instances
        let segmentChart, energyChart, billingChart, ownershipChart;
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadSegments();
            loadBillingIssues();
            loadValueSeekers();
            
            // Set notifications as default tab
            switchTab('notifications');
            
            // Set default filter
            document.getElementById('filter-all').style.opacity = '1';
        });

        async function loadStats() {
            try {
                const customersResponse = await fetch('/api/customers');
                const customers = await customersResponse.json();
                
                const billingResponse = await fetch('/api/billing-issues');
                const billingIssues = await billingResponse.json();
                
                // Count Value Seekers
                const valueSeekerCount = customers.filter(customer => customer.Segment === 'Value Seekers').length;
                
                document.getElementById('totalCustomers').textContent = customers.length;
                document.getElementById('billingIssues').textContent = billingIssues.length;
                document.getElementById('valueSeekers').textContent = valueSeekerCount;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('totalCustomers').textContent = 'Error';
                document.getElementById('billingIssues').textContent = 'Error';
                document.getElementById('valueSeekers').textContent = 'Error';
            }
        }

        async function loadSegments() {
            try {
                const response = await fetch('/api/segments');
                const segments = await response.json();
                
                let html = '';
                for (const [segment, data] of Object.entries(segments)) {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 5px;">
                            <strong>${segment}</strong><br>
                            <small>Customers: ${data.Customer_ID} | Avg Energy: ${data.Daily_Energy_Usage_kWh} kWh</small>
                        </div>
                    `;
                }
                
                document.getElementById('segmentData').innerHTML = html;
            } catch (error) {
                document.getElementById('segmentData').innerHTML = 'Error loading segments';
                console.error('Error:', error);
            }
        }

        async function loadBillingIssues() {
            try {
                const response = await fetch('/api/billing-issues');
                const issues = await response.json();
                
                let html = '';
                issues.slice(0, 5).forEach(issue => {
                    html += `
                        <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 3px;">
                            <strong>Customer ${issue.Customer_ID}</strong><br>
                            <small>${issue.Billing_Anomaly} - ${issue.Segment}</small>
                        </div>
                    `;
                });
                
                if (issues.length === 0) {
                    html = '<p>No billing issues found</p>';
                }
                
                document.getElementById('billingData').innerHTML = html;
            } catch (error) {
                document.getElementById('billingData').innerHTML = 'Error loading billing issues';
                console.error('Error:', error);
            }
        }

        // Store notifications globally for filtering
        let allNotifications = [];

        async function generateNotifications() {
            document.getElementById('notificationData').innerHTML = '<div class="loading">🤖 AI is analyzing customers and generating prioritized notifications...</div>';
            
            try {
                const response = await fetch('/api/notifications');
                const notifications = await response.json();
                
                // Store notifications for filtering
                allNotifications = notifications;
                
                // Update notification stats
                updateNotificationStats(notifications);
                
                // Display notifications (sorted by priority and risk)
                displayNotifications(notifications);
                
            } catch (error) {
                document.getElementById('notificationData').innerHTML = 'Error generating notifications';
                console.error('Error:', error);
            }
        }

        function displayNotifications(notifications) {
            // Sort notifications: High priority first, then by risk score descending
            const sortedNotifications = notifications.sort((a, b) => {
                const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                const aPriority = priorityOrder[a.priority] || 0;
                const bPriority = priorityOrder[b.priority] || 0;
                
                if (aPriority !== bPriority) {
                    return bPriority - aPriority; // Higher priority first
                }
                
                return (b.risk_score || 0) - (a.risk_score || 0); // Higher risk first within same priority
            });

            let html = '';
            
            if (sortedNotifications.length === 0) {
                html = '<div style="text-align: center; padding: 2rem; color: #666;">No notifications generated. All customers are in good standing.</div>';
            } else {
                sortedNotifications.forEach((notification, index) => {
                    const priorityIcon = notification.priority === 'high' ? '🔴' : 
                                       notification.priority === 'medium' ? '🟡' : '🟢';
                    const priorityLabel = notification.priority === 'high' ? 'CRITICAL' : 
                                        notification.priority === 'medium' ? 'IMPORTANT' : 'ROUTINE';
                    
                    html += `
                        <div class="notification-item priority-${notification.priority}" data-priority="${notification.priority}" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span style="font-size: 1.1rem;">${priorityIcon}</span>
                                        <strong style="font-size: 1.1rem;">Customer ${notification.customer_id}</strong>
                                        <span style="color: #666; font-size: 0.9rem;">(${notification.segment})</span>
                                        <span style="background: ${notification.priority === 'high' ? '#dc3545' : notification.priority === 'medium' ? '#ffc107' : '#28a745'}; color: ${notification.priority === 'medium' ? '#000' : 'white'}; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">
                                            ${priorityLabel}
                                        </span>
                                    </div>
                                    ${notification.risk_score ? `<div style="margin-bottom: 0.5rem;"><small style="background: ${notification.risk_score > 7 ? '#dc3545' : notification.risk_score > 4 ? '#ffc107' : '#28a745'}; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-weight: bold;">Risk Score: ${notification.risk_score}/10</small></div>` : ''}
                                </div>
                                <div style="text-align: right; font-size: 0.8rem; color: #666;">
                                    <div><strong>Urgency:</strong> ${notification.urgency ? notification.urgency.replace(/_/g, ' ') : 'Standard'}</div>
                                    <div><strong>Channel:</strong> ${notification.channel}</div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 0.75rem; font-weight: 500; color: #333; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${notification.priority === 'high' ? '#dc3545' : notification.priority === 'medium' ? '#ffc107' : '#28a745'};">
                                <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; text-transform: uppercase; font-weight: bold;">AI-Generated Message:</div>
                                "${notification.message}"
                            </div>
                            
                            ${notification.should_contact_reason ? `<div style="margin-bottom: 0.5rem; font-size: 0.85rem; color: #495057; background: #e9ecef; padding: 0.75rem; border-radius: 5px;"><strong>🎯 Why Contact:</strong> ${notification.should_contact_reason}</div>` : ''}
                            
                            ${notification.contact_strategy ? `<div style="margin-bottom: 0.75rem; font-size: 0.85rem; color: #495057;"><strong>📋 Strategy:</strong> ${notification.contact_strategy}</div>` : ''}
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; border-top: 1px solid #dee2e6;">
                                <small style="color: #666;">Type: ${notification.type} | Rank: #${index + 1}</small>
                                <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: bold;" 
                                        onclick="sendNotification(${notification.customer_id}, '${notification.message.replace(/'/g, "\\'")}', '${notification.channel}')">
                                    📤 Send Now
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('notificationData').innerHTML = html;
        }

        function updateNotificationStats(notifications) {
            const total = notifications.length;
            const highPriority = notifications.filter(n => n.priority === 'high').length;
            const mediumPriority = notifications.filter(n => n.priority === 'medium').length;
            const lowPriority = notifications.filter(n => n.priority === 'low').length;
            
            const avgRisk = notifications.length > 0 ? 
                (notifications.reduce((sum, n) => sum + (n.risk_score || 0), 0) / notifications.length).toFixed(1) : 0;
            
            document.getElementById('totalNotifications').textContent = total;
            document.getElementById('highPriorityCount').textContent = highPriority;
            document.getElementById('mediumPriorityCount').textContent = mediumPriority;
            document.getElementById('lowPriorityCount').textContent = lowPriority;
            document.getElementById('avgRiskScore').textContent = avgRisk;
        }

        function filterNotifications(priority) {
            // Update filter button states
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.style.opacity = '0.6';
                btn.style.transform = 'scale(0.95)';
            });
            document.getElementById(`filter-${priority}`).style.opacity = '1';
            document.getElementById(`filter-${priority}`).style.transform = 'scale(1)';
            
            let filteredNotifications = allNotifications;
            
            if (priority !== 'all') {
                filteredNotifications = allNotifications.filter(n => n.priority === priority);
            }
            
            displayNotifications(filteredNotifications);
            
            // Update stats for filtered view
            updateNotificationStats(filteredNotifications);
        }

        async function generateValueSeekerNotifications() {
            // Switch to notifications tab and generate notifications focused on Value Seekers
            switchTab('notifications');
            setTimeout(() => {
                generateNotifications();
            }, 300);
        }

        async function sendNotification(customerId, message, channel) {
            try {
                const response = await fetch('/api/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        message: message,
                        channel: channel
                    })
                });
                
                const result = await response.json();
                alert(`Notification sent to customer ${customerId} via ${channel}`);
            } catch (error) {
                alert('Error sending notification');
                console.error('Error:', error);
            }
        }

        async function loadCustomerData() {
            try {
                // Show loading state
                document.getElementById('segmentData').innerHTML = '<div class="loading">Refreshing data...</div>';
                document.getElementById('billingData').innerHTML = '<div class="loading">Refreshing data...</div>';
                
                // Call the refresh endpoint to reload CSV data
                const refreshResponse = await fetch('/api/refresh-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const refreshResult = await refreshResponse.json();
                
                if (refreshResult.status === 'success') {
                    // Reload all dashboard data
                    await loadStats();
                    await loadSegments();
                    await loadBillingIssues();
                    await loadValueSeekers();
                    await loadCustomerAnalysis();
                    await loadCharts();
                    
                    // Clear any existing notifications
                    document.getElementById('notificationData').innerHTML = 'Click "Generate Notifications" to see AI-prioritized notifications';
                    document.getElementById('pendingNotifications').textContent = '0';
                    
                    alert(`Data refreshed successfully! Loaded ${refreshResult.total_customers} customers.`);
                } else {
                    alert(`Error refreshing data: ${refreshResult.message}`);
                }
            } catch (error) {
                alert('Error refreshing data. Please try again.');
                console.error('Error:', error);
                
                // Restore loading state on error
                document.getElementById('segmentData').innerHTML = 'Error loading segments';
                document.getElementById('billingData').innerHTML = 'Error loading billing issues';
            }
        }

        function viewSegments() {
            loadSegments();
        }

        function viewBillingIssues() {
            loadBillingIssues();
        }

        async function loadValueSeekers() {
            try {
                const response = await fetch('/api/value-seekers');
                const data = await response.json();
                
                let html = `
                    <!-- Key Metrics Grid -->
                    <div class="value-seekers-grid">
                        <div class="value-seekers-metric">
                            <div class="metric-value">${data.total_count}</div>
                            <div class="metric-label">Total Value Seekers</div>
                        </div>
                        <div class="value-seekers-metric">
                            <div class="metric-value">${data.avg_daily_energy}</div>
                            <div class="metric-label">Avg Daily Energy (kWh)</div>
                        </div>
                        <div class="value-seekers-metric">
                            <div class="metric-value">${data.avg_campaign_clicks}</div>
                            <div class="metric-label">Avg Campaign Clicks</div>
                        </div>
                        <div class="value-seekers-metric">
                            <div class="metric-value">${data.avg_campaign_opens}</div>
                            <div class="metric-label">Avg Campaign Opens</div>
                        </div>
                    </div>
                    
                    <!-- Detailed Insights -->
                    <div class="insights-section">
                        <div class="insight-card">
                            <h4>🔋 Solar/EV Ownership</h4>
                `;
                
                for (const [ownership, count] of Object.entries(data.solar_ev_breakdown)) {
                    html += `
                        <div class="insight-item">
                            <span class="insight-label">${ownership}</span>
                            <span class="insight-value">${count} customers</span>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                        <div class="insight-card">
                            <h4>💳 Billing Issues</h4>
                `;
                
                for (const [issue, count] of Object.entries(data.billing_issues)) {
                    html += `
                        <div class="insight-item">
                            <span class="insight-label">${issue}</span>
                            <span class="insight-value">${count} customers</span>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                    
                    <!-- Key Insights Summary -->
                    <div class="key-insights">
                        <h4>💡 Key Insights</h4>
                        <div class="insight-point">
                            <span class="insight-icon">📊</span>
                            <span class="insight-text">Value Seekers represent ${((data.total_count / 20) * 100).toFixed(1)}% of your customer base</span>
                        </div>
                        <div class="insight-point">
                            <span class="insight-icon">⚡</span>
                            <span class="insight-text">Their average energy usage is ${data.avg_daily_energy} kWh/day</span>
                        </div>
                        <div class="insight-point">
                            <span class="insight-icon">📧</span>
                            <span class="insight-text">Campaign engagement: ${data.avg_campaign_clicks} clicks, ${data.avg_campaign_opens} opens on average</span>
                        </div>
                        <div class="insight-point">
                            <span class="insight-icon">📍</span>
                            <span class="insight-text">Most common regions: ${Object.keys(data.regions).slice(0, 2).join(', ')}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('valueSeekerData').innerHTML = html;
            } catch (error) {
                document.getElementById('valueSeekerData').innerHTML = 'Error loading Value Seekers data';
                console.error('Error:', error);
            }
        }

        async function loadCustomerAnalysis() {
            try {
                document.getElementById('customerAnalysisData').innerHTML = '<div class="loading">AI is analyzing customers...</div>';
                
                const response = await fetch('/api/customer-analysis');
                const analyses = await response.json();
                
                let html = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #667eea;">
                        <h4 style="color: #667eea; margin-bottom: 0.5rem;">🎯 AI Prioritization Results</h4>
                        <p style="color: #495057; margin: 0;">AI has analyzed ${analyses.length} customers and ranked them by priority, urgency, and churn risk.</p>
                    </div>
                    
                    <div style="display: grid; gap: 0.75rem;">
                `;
                
                analyses.slice(0, 8).forEach((analysis, index) => {
                    const priorityColor = analysis.priority === 'high' ? '#dc3545' : 
                                        analysis.priority === 'medium' ? '#ffc107' : '#28a745';
                    const riskColor = analysis.risk_score > 7 ? '#dc3545' : 
                                     analysis.risk_score > 4 ? '#ffc107' : '#28a745';
                    
                    html += `
                        <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid ${priorityColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <div>
                                    <strong>Customer ${analysis.customer_id}</strong> (${analysis.segment})
                                    <div style="margin-top: 0.25rem;">
                                        <span style="background: ${priorityColor}; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-right: 0.5rem;">
                                            ${analysis.priority.toUpperCase()} PRIORITY
                                        </span>
                                        <span style="background: ${riskColor}; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">
                                            Risk: ${analysis.risk_score}/10
                                        </span>
                                    </div>
                                </div>
                                <div style="text-align: right; font-size: 0.8rem; color: #666;">
                                    <div><strong>Urgency:</strong> ${analysis.urgency.replace(/_/g, ' ')}</div>
                                    <div><strong>Channel:</strong> ${analysis.recommended_channel}</div>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: #555; margin-bottom: 0.5rem;">
                                <strong>Reason:</strong> ${analysis.reason}
                            </div>
                            <div style="font-size: 0.85rem; color: #666; font-style: italic;">
                                <strong>Strategy:</strong> ${analysis.contact_strategy}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                if (analyses.length === 0) {
                    html = '<p>No customer analysis available. AI service may be unavailable.</p>';
                }
                
                document.getElementById('customerAnalysisData').innerHTML = html;
            } catch (error) {
                document.getElementById('customerAnalysisData').innerHTML = 'Error loading AI customer analysis. AI service may be unavailable.';
                console.error('Error:', error);
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const clickedButton = event ? event.target : document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // Load data for specific tabs if needed
            if (tabName === 'value-seekers') {
                // Refresh Value Seekers data if needed
                if (document.getElementById('valueSeekerData').innerHTML.includes('Loading')) {
                    loadValueSeekers();
                }
            }
        }

        async function loadCharts() {
            try {
                const customersResponse = await fetch('/api/customers');
                const customers = await customersResponse.json();
                
                const segmentsResponse = await fetch('/api/segments');
                const segments = await segmentsResponse.json();
                
                // Create charts
                createSegmentChart(segments);
                createEnergyChart(segments);
                createBillingChart(customers);
                createOwnershipChart(customers);
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        function createSegmentChart(segments) {
            const ctx = document.getElementById('segmentChart').getContext('2d');
            
            if (segmentChart) {
                segmentChart.destroy();
            }
            
            const labels = Object.keys(segments);
            const data = Object.values(segments).map(s => s.Customer_ID);
            
            segmentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createEnergyChart(segments) {
            const ctx = document.getElementById('energyChart').getContext('2d');
            
            if (energyChart) {
                energyChart.destroy();
            }
            
            const labels = Object.keys(segments);
            const data = Object.values(segments).map(s => s.Daily_Energy_Usage_kWh);
            
            energyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Avg Daily Energy Usage (kWh)',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createBillingChart(customers) {
            const ctx = document.getElementById('billingChart').getContext('2d');
            
            if (billingChart) {
                billingChart.destroy();
            }
            
            const billingCounts = customers.reduce((acc, customer) => {
                const anomaly = customer.Billing_Anomaly || 'None';
                acc[anomaly] = (acc[anomaly] || 0) + 1;
                return acc;
            }, {});
            
            const labels = Object.keys(billingCounts);
            const data = Object.values(billingCounts);
            
            billingChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#27ae60',
                            '#e74c3c',
                            '#f39c12',
                            '#9b59b6'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createOwnershipChart(customers) {
            const ctx = document.getElementById('ownershipChart').getContext('2d');
            
            if (ownershipChart) {
                ownershipChart.destroy();
            }
            
            const ownershipCounts = customers.reduce((acc, customer) => {
                const ownership = customer.Solar_EV_Ownership || 'None';
                acc[ownership] = (acc[ownership] || 0) + 1;
                return acc;
            }, {});
            
            const labels = Object.keys(ownershipCounts);
            const data = Object.values(ownershipCounts);
            
            ownershipChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Customers',
                        data: data,
                        backgroundColor: [
                            '#3498db',
                            '#2ecc71',
                            '#e67e22',
                            '#95a5a6'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>